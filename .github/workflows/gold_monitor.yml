name: Gold Price Monitor

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿè¿è¡Œï¼ˆä¾‹å¦‚ 1:05, 2:05...ï¼‰
  schedule:
    - cron: '5 */1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨GitHubé¡µé¢ä¸Šæ‰‹åŠ¨è¿è¡Œï¼‰
  workflow_dispatch:
  
  # å½“ä»£ç æœ‰pushæ—¶ä¹Ÿè¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
  push:
    branches: [ main ]

jobs:
  monitor:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„Ubuntuç³»ç»Ÿ
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´è¿è¡Œ
    timeout-minutes: 10
    
    # è®¾ç½®æƒé™ï¼Œå…è®¸ä¸Šä¼ æ–‡ä»¶
    permissions:
      contents: write
      actions: read
      checks: write
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ï¼ˆæŠŠä»“åº“ä»£ç ä¸‹è½½åˆ°è™šæ‹Ÿæœºï¼‰
    - name: Checkout code
      uses: actions/checkout@v4  # æ›´æ–°åˆ°v4
      
    # æ­¥éª¤2ï¼šè®¾ç½®PythonçŽ¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5  # æ›´æ–°åˆ°v5
      with:
        python-version: '3.11'  # ä½¿ç”¨Python 3.11ï¼Œæ›´ç¨³å®š
        
    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    # æ­¥éª¤4ï¼šè¿è¡Œé‡‘ä»·ç›‘æŽ§è„šæœ¬
    - name: Get gold price
      env:
        # ä»ŽGitHub Secretsè¯»å–é…ç½®
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GOLDAPI_TOKEN: ${{ secrets.GOLDAPI_TOKEN }}
      run: |
        echo "ðŸŸ¡ å¼€å§‹èŽ·å–é‡‘ä»·..."
        python gold_price.py
        echo "âœ… ä»»åŠ¡å®Œæˆ"
        
    # æ­¥éª¤5ï¼šä¸Šä¼ åŽ†å²è®°å½•æ–‡ä»¶ï¼ˆä½¿ç”¨v4ç‰ˆæœ¬ï¼‰
    - name: Upload history file
      uses: actions/upload-artifact@v4  # é‡è¦ï¼šä½¿ç”¨v4è€Œä¸æ˜¯v3
      if: always()  # å³ä½¿ä¹‹å‰çš„æ­¥éª¤å¤±è´¥ä¹Ÿä¸Šä¼ 
      with:
        name: gold-price-history
        path: |
          gold_history.json
          gold_price.py
        retention-days: 30  # ä¿ç•™30å¤©
        
    # æ­¥éª¤6ï¼šä¸Šä¼ ç»“æžœåˆ°å·¥ä½œæµæ€»ç»“ï¼ˆå¯é€‰ï¼‰
    - name: Create workflow summary
      if: always()
      run: |
        echo "## é‡‘ä»·ç›‘æŽ§æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æžœæœ‰åŽ†å²æ–‡ä»¶ï¼Œæ˜¾ç¤ºæœ€æ–°è®°å½•
        if [ -f "gold_history.json" ]; then
          echo "### æœ€æ–°é‡‘ä»·è®°å½•" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          tail -n 1 gold_history.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
